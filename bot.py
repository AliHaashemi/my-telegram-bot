import os
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from supabase import create_client, Client
from openai import OpenAI

# Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
BOT_TOKEN = os.environ.get('BOT_TOKEN')
HF_TOKEN = os.environ.get('HF_TOKEN')
SUPABASE_URL = os.environ.get('SUPABASE_URL')
SUPABASE_KEY = os.environ.get('SUPABASE_KEY')

# Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù‡Ù…Ù‡ Ù…ØªØºÛŒØ±Ù‡Ø§
if not BOT_TOKEN:
    raise ValueError("âŒ Ù„Ø·ÙØ§Ù‹ BOT_TOKEN Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯")
if not HF_TOKEN:
    raise ValueError("âŒ Ù„Ø·ÙØ§Ù‹ HF_TOKEN Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯")
if not SUPABASE_URL:
    raise ValueError("âŒ Ù„Ø·ÙØ§Ù‹ SUPABASE_URL Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯")
if not SUPABASE_KEY:
    raise ValueError("âŒ Ù„Ø·ÙØ§Ù‹ SUPABASE_KEY Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯")

# Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª Supabase
supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª OpenAI Ø¨Ø±Ø§ÛŒ Hugging Face
client = OpenAI(
    base_url="https://router.huggingface.co/v1",
    api_key=HF_TOKEN,
)

def query_moonshot_ai(prompt):
    """Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Moonshot"""
    try:
        completion = client.chat.completions.create(
            model="moonshotai/Kimi-K2-Instruct-0905:together",
            messages=[
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            max_tokens=500,
            temperature=0.7
        )
        return completion.choices[0].message.content
    except Exception as e:
        return f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ: {str(e)}"

async def save_user(update: Update):
    """Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Supabase"""
    user = update.effective_user
    try:
        # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
        existing_user = supabase.table("users").select("*").eq("user_id", user.id).execute()
        
        if len(existing_user.data) == 0:
            # Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
            supabase.table("users").insert({
                "user_id": user.id,
                "username": user.username,
                "first_name": user.first_name,
                "last_name": user.last_name,
                "message_count": 1
            }).execute()
            print(f"âœ… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯: {user.id}")
        else:
            # Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯
            supabase.table("users").update({
                "message_count": existing_user.data[0]["message_count"] + 1,
                "username": user.username,
                "first_name": user.first_name,
                "last_name": user.last_name
            }).eq("user_id", user.id).execute()
            
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±: {e}")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¯Ø³ØªÙˆØ± Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª"""
    await save_user(update)
    await update.message.reply_text(
        'Ø³Ù„Ø§Ù…! ğŸ‘‹\n'
        'Ù…Ù† ÛŒÚ© Ø±Ø¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯Ù… Ú©Ù‡ Ø¨Ø§ Moonshot AI Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù….\n'
        'Ù‡Ø± Ù¾ÛŒØ§Ù…ÛŒ Ø¨ÙØ±Ø³ØªÛŒØ¯ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù…!'
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±"""
    await save_user(update)
    user_text = update.message.text
    
    # Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª ØªØ§ÛŒÙ¾ Ú©Ø±Ø¯Ù†
    await update.message.reply_chat_action("typing")
    
    # Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
    response_text = query_moonshot_ai(user_text)
    
    # Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    await update.message.reply_text(response_text[:4000])

async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†"""
    try:
        result = supabase.table("users").select("count").execute()
        total_users = len(result.data)
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        total_messages = supabase.table("users").select("message_count").execute()
        total_msg_count = sum(user['message_count'] for user in total_messages.data)
        
        await update.message.reply_text(
            f"ğŸ“Š Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª:\n"
            f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {total_users}\n"
            f"ğŸ’¬ Ù…Ø¬Ù…ÙˆØ¹ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: {total_msg_count}"
        )
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±: {e}")

async def myinfo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ"""
    user = update.effective_user
    try:
        user_data = supabase.table("users").select("*").eq("user_id", user.id).execute()
        
        if user_data.data:
            data = user_data.data[0]
            await update.message.reply_text(
                f"ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§:\n"
                f"ğŸ†” ID: {data['user_id']}\n"
                f"ğŸ‘¤ Ù†Ø§Ù…: {data['first_name']} {data['last_name']}\n"
                f"ğŸ“§ username: @{data['username']}\n"
                f"ğŸ’¬ ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: {data['message_count']}\n"
                f"ğŸ“… Ø¹Ø¶Ùˆ since: {data['created_at']}"
            )
        else:
            await update.message.reply_text("âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯")
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: {e}")

def main():
    """ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª"""
    # Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø¨Ø§Øª
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÙˆØ±Ø§Øª
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("stats", stats))
    application.add_handler(CommandHandler("myinfo", myinfo))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    print("âœ… Ø±Ø¨Ø§Øª Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ú©Ø±Ø¯:")
    print("   - Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Moonshot")
    print("   - Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Supabase")
    print("   - Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†")
    print("   - Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ")
    
    # Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
    application.run_polling()

if __name__ == '__main__':
    main()
